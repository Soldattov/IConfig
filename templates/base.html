{% load static %}
<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Snitch PC - Магазин игровых компьютеров{% endblock %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
    {% block head %}{% endblock %}
</head>

<body>


    <header class="header">
        <div class="container">
            <div class="header-top">
                <a href="/" class="logo">
                    <img src="https://www.meme-arsenal.com/memes/a706819c0690421e2fb711ea578742cb.jpg"
                        alt="Snitch PC Logo" width="60">
                    <span>Snitch PC</span>
                </a>

                <div class="header-search">
                    <input type="text" placeholder="Поиск игровых ПК, ноутбуков и комплектующих...">
                </div>

                <div class="header-actions">
                    <button id="user-icon" class="btn-user"><i class="far fa-user"></i></button>
                    <a href="{% url 'feedback' %}" class="btn-feedback">
                        <img src="{% get_media_prefix %}reviews.png" alt="Отзывы"
                            style="height: 24px; width: auto;"></a>
                    <a href="#"><i class="fas fa-shopping-cart"></i><span>2</span></a>
                </div>
            </div>
        </div>
    </header>

    {% include 'users/modals.html' %}


    <!-- Основной контент страницы -->
    <main>
        {% block content %}
        {% endblock %}
    </main>

    <!-- Блок для дополнительных скриптов, задаваемых дочерними шаблонами -->
    {% block scripts %}{% endblock %}
    <!-- ======================================================= -->

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Ссылки на модальные окна, кнопки закрытия 
            const modals = document.querySelectorAll('.modal');
            const closeButtons = document.querySelectorAll('.modal-close');
            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.getElementById('register-btn');
            const loginModal = document.getElementById('login-modal');
            const registerModal = document.getElementById('register-modal');
            const verificationModal = document.getElementById('verification-modal');
            const verifyBack = document.getElementById('verify-back');
            const verifyClose = document.getElementById('verify-close');

            // Функция очистки всех полей в модальном окне 
            function clearFormInputs(modal) {
                modal.querySelectorAll('input:not([name="csrfmiddlewaretoken"])').forEach(input => input.value = '');
                modal.querySelectorAll('.error-message').forEach(error => error.innerText = '');
            }

            // Открытие окна входа 
            if (loginBtn) {
                loginBtn.addEventListener('click', function () {
                    clearFormInputs(loginModal);
                    loginModal.classList.remove('hidden');
                });
            }
            // Открытие окна регистрации 
            if (registerBtn) {
                registerBtn.addEventListener('click', function () {
                    clearFormInputs(registerModal);
                    registerModal.classList.remove('hidden');
                });
            }
            // Обработка кнопки возврата в модальном окне проверки 
            if (verifyBack) {
                verifyBack.addEventListener('click', function () {
                    verificationModal.classList.add('hidden');
                    const registerModal = document.getElementById('register-modal');
                    if (registerModal) {
                        registerModal.classList.remove('hidden');
                    }
                });
            }
            if (verifyClose) {
                verifyClose.addEventListener('click', function () {
                    verificationModal.classList.add('hidden');
                });
            }
            // Меню пользователя 
            const userIcon = document.getElementById('user-icon');
            const userMenu = document.getElementById('user-menu');
            if (userIcon) {
                userIcon.addEventListener('click', function (e) {
                    const rect = userIcon.getBoundingClientRect();
                    userMenu.style.position = 'fixed';
                    userMenu.style.left = rect.left + "px";
                    userMenu.style.top = (rect.bottom + 5) + "px";
                    userMenu.classList.toggle('hidden');
                    modals.forEach(modal => modal.classList.add('hidden'));
                    e.stopPropagation();
                });
            }
            document.addEventListener('click', function (e) {
                if (userMenu && !userMenu.contains(e.target) && e.target !== userIcon) {
                    userMenu.classList.add('hidden');
                }
            });
            // Закрытие модальных окон по нажатию на кнопки закрытия
            closeButtons.forEach(button => {
                button.addEventListener('click', function () {
                    modals.forEach(modal => modal.classList.add('hidden'));
                });
            });

            const registerForm = document.getElementById('register-form');

            const password1Field = document.getElementById('password1');
            const password2Field = document.getElementById('password2');
            const password1Error = document.getElementById('password1-error');
            const password2Error = document.getElementById('password2-error');

            // Валидация паролей 
            function validatePasswords() {
                let valid = true;
                if (password1Field.value.length < 8) {
                    password1Error.innerText = "Пароль должен быть не менее 8 символов";
                    password1Error.style.display = 'block';
                    password1Field.classList.add('error');
                    valid = false;
                } else {
                    password1Error.innerText = "";
                    password1Error.style.display = 'none';
                    password1Field.classList.remove('error');
                }
                if (password2Field.value && password2Field.value !== password1Field.value) {
                    password2Error.innerText = "Пароли не совпадают";
                    password2Error.style.display = 'block';
                    password2Field.classList.add('error');
                    valid = false;
                } else {
                    password2Error.innerText = "";
                    password2Error.style.display = 'none';
                    password2Field.classList.remove('error');
                }
                return valid;
            }
            password1Field.addEventListener('input', validatePasswords);
            password2Field.addEventListener('input', validatePasswords);
            registerForm.addEventListener('submit', function (e) {
                if (!validatePasswords()) {
                    e.preventDefault();
                }
            });

            // Валидация email с использованием регулярного выражения
            const emailField = document.getElementById('register-email');
            const emailError = document.getElementById('email-error');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            emailField.addEventListener('input', function () {
                if (!emailRegex.test(emailField.value)) {
                    emailError.innerText = "Некорректный email";
                    emailError.style.display = 'block';
                    emailField.classList.add('error');
                } else {
                    emailError.innerText = "";
                    emailError.style.display = 'none';
                    emailField.classList.remove('error');
                }
            });


            if (typeof login_error !== 'undefined' && login_error) {
                loginModal?.classList.remove('hidden');
            }


        });
    </script>


</body>

</html>